name: Create ClickUp Release Notes

on:
  push:
    paths:
      - 'release-notes/*.md'
      - 'release-data/*.json'
  workflow_dispatch:
    inputs:
      file_path:
        description: 'Path to the release notes file (JSON or MD)'
        required: true
        type: string

jobs:
  create-clickup-doc:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get changed files
        id: changed-files
        if: github.event_name == 'push'
        run: |
          # Get both JSON and MD files
          changed_files=$(git diff --name-only HEAD~1 HEAD -- 'release-notes/*.md' 'release-data/*.json' | tr '\n' ' ')
          echo "files=$changed_files" >> $GITHUB_OUTPUT

      - name: Set file path for manual trigger
        id: manual-file
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "files=${{ github.event.inputs.file_path }}" >> $GITHUB_OUTPUT

      - name: Process and create ClickUp docs
        env:
          CLICKUP_API_TOKEN: ${{ secrets.CLICKUP_API_TOKEN }}
          CLICKUP_WORKSPACE_ID: ${{ secrets.CLICKUP_WORKSPACE_ID }}
          CLICKUP_DOC_ID: ${{ secrets.CLICKUP_DOC_ID }}
          CLICKUP_PARENT_PAGE_ID: ${{ secrets.CLICKUP_PARENT_PAGE_ID }}
        run: |
          FILES="${{ steps.changed-files.outputs.files }}${{ steps.manual-file.outputs.files }}"

          if [ -z "$FILES" ]; then
            echo "No release notes files found"
            exit 0
          fi

          for file in $FILES; do
            if [ -f "$file" ]; then
              echo "Processing: $file"

              # Check if it's a JSON file
              if [[ "$file" == *.json ]]; then
                echo "Converting JSON to Markdown..."
                # Generate markdown from JSON
                node scripts/generate-release-notes.js "$file" /tmp/release-notes.md 2>/tmp/page-info.txt

                # Extract page name
                PAGE_NAME=$(grep "PAGE_NAME=" /tmp/page-info.txt | cut -d'=' -f2)
                echo "Page name: $PAGE_NAME"

                # Create ClickUp doc with generated markdown
                node scripts/create-clickup-doc.js /tmp/release-notes.md "$PAGE_NAME"
              else
                # It's already markdown, process directly
                node scripts/create-clickup-doc.js "$file"
              fi
            fi
          done
